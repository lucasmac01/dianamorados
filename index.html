<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nosso Tempo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --accent: #ef4444; }
    .pop{animation:pop .28s ease-out}@keyframes pop{0%{transform:scale(.97);opacity:.7}60%{transform:scale(1.02);opacity:1}100%{transform:scale(1)}}
    .soft{box-shadow:0 1px 0 rgba(0,0,0,.04),0 1px 2px rgba(0,0,0,.06)}
    .card-accent{border-top:4px solid rgba(239,68,68,.22)}
  </style>
</head>
<body class="bg-white text-gray-800 antialiased">
  <!-- Header pequeno -->
  <header class="py-3 text-center">
    <div class="text-sm font-medium text-[var(--accent)]">Gatinho ❤️ Gatinha</div>
  </header>

  <main class="min-h-screen max-w-xl mx-auto px-4 sm:px-6 py-8">
    <!-- CONTADOR -->
    <section class="rounded-2xl border soft card-accent p-6 sm:p-8 bg-white">
      <header class="text-center">
        <h1 class="text-2xl font-semibold text-gray-900">Nosso Tempo</h1>
        <p class="mt-1 text-sm text-gray-500">Contador de amor</p>
      </header>
      <div class="mt-6 text-center">
        <p class="text-sm text-gray-600">Juntos há</p>
        <div class="mt-1">
          <span id="totalDays" class="text-6xl font-extrabold text-[var(--accent)] tabular-nums">—</span>
        </div>
        <p class="mt-1 text-xs text-gray-400">dias</p>
        <p id="ymdBreakdown" class="mt-3 text-gray-700 tabular-nums">—</p>
        <p id="sinceDate" class="mt-1 text-xs text-gray-500">Início: —</p>
      </div>
    </section>

    <!-- RESGATE (dia 15) -->
    <section class="mt-8 rounded-2xl border soft p-6 sm:p-8 bg-white">
      <div class="flex items-center justify-between gap-4">
        <h2 class="text-lg font-semibold text-gray-900">Cartão + Brinde do mês</h2>
        <span id="redeemStatus" class="text-[10px] uppercase tracking-wide rounded-full px-2 py-1 border bg-gray-50 text-gray-600">Verificando…</span>
      </div>
      <p class="mt-2 text-sm text-gray-600">Disponível exclusivamente no <strong>dia 15</strong>, uma vez por mês (America/Sao_Paulo).</p>
      <div class="mt-5">
        <button id="btnRedeem" class="w-full sm:w-auto rounded-2xl px-6 py-3 text-sm font-semibold transition border shadow hover:shadow-md focus:outline-none disabled:opacity-70 disabled:cursor-not-allowed">Resgatar Cartão + Brinde</button>
      </div>
      <div id="giftArea" class="mt-5 hidden">
        <div class="rounded-xl border p-4">
          <p id="giftMessage" class="text-gray-700"></p>
          <p class="mt-2 text-xs uppercase tracking-wide text-gray-500">Brinde</p>
          <p id="giftCode" class="mt-1 font-mono text-sm text-gray-900 select-all">—</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== Config =====
    const START_DATE_ISO = '2025-03-15'; // 15/03/2025
    const LS_KEYS = { lastGift: 'gift_lastRedeem' };

    // ===== Timezone utils (America/Sao_Paulo) =====
    function getTodayBR(){
      const parts = new Intl.DateTimeFormat('pt-BR',{timeZone:'America/Sao_Paulo',day:'2-digit',month:'2-digit',year:'numeric'}).formatToParts(new Date());
      const m = Object.fromEntries(parts.map(p=>[p.type,p.value]));
      return new Date(+m.year, +m.month-1, +m.day);
    }
    function parseISODateOnly(iso){ if(!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return null; const [Y,M,D]=iso.split('-').map(Number); return new Date(Y,M-1,D); }
    function diffDays(a,b){ return Math.floor((b-a)/(24*60*60*1000)); }
    function diffYMD(a,b){ let y=b.getFullYear()-a.getFullYear(); let m=b.getMonth()-a.getMonth(); let d=b.getDate()-a.getDate(); if(d<0){const prev=new Date(b.getFullYear(),b.getMonth(),0); d+=prev.getDate(); m--; } if(m<0){ m+=12; y--; } return {years:y,months:m,days:d}; }
    const toYYYYMM = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

    // ===== Elements =====
    const el = {
      totalDays: document.getElementById('totalDays'),
      ymdBreakdown: document.getElementById('ymdBreakdown'),
      sinceDate: document.getElementById('sinceDate'),
      btn: document.getElementById('btnRedeem'),
      status: document.getElementById('redeemStatus'),
      giftArea: document.getElementById('giftArea'),
      giftMessage: document.getElementById('giftMessage'),
      giftCode: document.getElementById('giftCode'),
    };

    // ===== Counter =====
    function updateCounter(){
      const today = getTodayBR();
      const start = parseISODateOnly(START_DATE_ISO);
      if(!start || start>today){
        el.totalDays.textContent = '0';
        el.ymdBreakdown.textContent = '0 anos • 0 meses • 0 dias';
        el.sinceDate.textContent = 'Início: data inválida';
        return;
      }
      const total = diffDays(start,today);
      const br = diffYMD(start,today);
      el.totalDays.textContent = String(total);
      el.ymdBreakdown.textContent = `${br.years} ${br.years===1?'ano':'anos'} • ${br.months} ${br.months===1?'mês':'meses'} • ${br.days} ${br.days===1?'dia':'dias'}`;
      const [yy,mm,dd] = START_DATE_ISO.split('-');
      el.sinceDate.textContent = `Início: ${dd}/${mm}/${yy}`;
      el.totalDays.classList.remove('pop'); void el.totalDays.offsetWidth; el.totalDays.classList.add('pop');
    }

    // ===== Redeem rules =====
    function canRedeemToday(){
      const today = getTodayBR();
      if(today.getDate() !== 15) return { ok:false, reason:'not15' };
      const currentYM = toYYYYMM(today);
      const last = localStorage.getItem(LS_KEYS.lastGift)||'';
      if(last === currentYM) return { ok:false, reason:'already' };
      return { ok:true };
    }
    function updateButton(){
      const BTN_BASE = 'w-full sm:w-auto rounded-2xl px-6 py-3 text-sm font-semibold transition border shadow hover:shadow-md focus:outline-none disabled:opacity-70 disabled:cursor-not-allowed';
      const RED = 'bg-[var(--accent)]/10 text-[var(--accent)] border-[var(--accent)]/30 hover:bg-[var(--accent)]/10 focus:ring-2 focus:ring-[var(--accent)]/30';
      const GREEN = 'bg-emerald-600 hover:bg-emerald-700 text-white border-emerald-700/20 focus:ring-2 focus:ring-emerald-600';

      const av = canRedeemToday();
      if(av.ok){
        el.btn.disabled = false; el.btn.className = BTN_BASE + ' ' + GREEN; el.btn.textContent = 'Resgatar Cartão + Brinde';
        el.status.textContent = 'Disponível hoje (dia 15)'; el.status.className='text-[10px] uppercase tracking-wide rounded-full px-2 py-1 border bg-emerald-50 text-emerald-700 border-emerald-200';
      } else {
        el.btn.disabled = true; el.btn.className = BTN_BASE + ' ' + RED; el.btn.textContent = (av.reason==='already'?'Já resgatado este mês':'Disponível no dia 15');
        const t = getTodayBR();
        el.status.textContent = av.reason==='already' ? 'Já resgatado — libera na virada do mês' : `Hoje é ${String(t.getDate()).padStart(2,'0')}/${String(t.getMonth()+1).padStart(2,'0')}`;
        el.status.className='text-[10px] uppercase tracking-wide rounded-full px-2 py-1 border bg-gray-50 text-gray-600';
      }
    }
    function randomGift(){
      const msgs = ['Um passeio juntos','Café da tarde a dois','Filme e pipoca','Jantar romântico em casa'];
      const code = 'BRINDE-' + Math.random().toString(36).slice(2,8).toUpperCase();
      return { text: msgs[Math.floor(Math.random()*msgs.length)], code };
    }
    function redeem(){
      const av = canRedeemToday(); if(!av.ok) return;
      localStorage.setItem(LS_KEYS.lastGift, toYYYYMM(getTodayBR()));
      const g = randomGift();
      el.giftMessage.textContent = g.text;
      el.giftCode.textContent = g.code;
      el.giftArea.classList.remove('hidden');
      updateButton();
    }

    // ===== Init & events =====
    document.getElementById('btnRedeem').addEventListener('click', redeem);
    (function init(){
      updateCounter();
      updateButton();
      // tick na virada de dia (SP)
      const now=new Date(); const todayBR=getTodayBR(); const next=new Date(todayBR); next.setDate(todayBR.getDate()+1);
      setTimeout(()=>{ updateCounter(); updateButton(); setInterval(()=>{ updateCounter(); updateButton(); }, 24*60*60*1000); }, next-now);
    })();
  </script>
</body>
</html>
